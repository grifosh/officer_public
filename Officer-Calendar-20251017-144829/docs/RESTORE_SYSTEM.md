# Система детального логирования и восстановления событий

## Обзор

Система теперь включает максимально детальное логирование всех операций с событиями для возможности полного восстановления данных при случайном удалении или изменении.

## Новые возможности

### 1. Автоматическая синхронизация с Google Calendar

- **Обновления событий** автоматически синхронизируются с Google Calendar
- **Удаления событий** автоматически синхронизируются с Google Calendar
- **Обработка ошибок** синхронизации с детальным логированием

### 2. Детальное логирование для восстановления

#### Новые лог-файлы:
- `logs/event_backups.log` - детальные backup'ы всех операций (50MB, 30 файлов = месяц)
- `logs/event_restores.log` - логи восстановления событий (10MB, 14 файлов = 2 недели)

#### Что логируется:
- **Создание событий** - полные данные события
- **Обновления событий** - полные данные до и после изменения
- **Удаления событий** - полные данные для восстановления
- **Синхронизация с Google Calendar** - успех/неудача операций
- **Восстановление событий** - детали процесса восстановления

### 3. API для восстановления

#### Получить список backup'ов для восстановления:
```bash
GET /api/events/backups
```

#### Восстановить событие из backup'а:
```bash
POST /api/events/restore/{backup_id}
```

## Использование

### Тестирование восстановления

Используйте скрипт `test_restore.py`:

```bash
# Интерактивный режим
python test_restore.py

# Восстановить конкретный backup
python test_restore.py delete_123_20250113_143022
```

### Примеры backup'ов

Каждый backup содержит:
```json
{
  "timestamp": "2025-01-13T14:30:22.123456",
  "operation": "delete",
  "event_id": 123,
  "event_data": {
    "id": 123,
    "subject": "Важная встреча",
    "start_time": "2025-01-13T10:00:00",
    "end_time": "2025-01-13T11:00:00",
    "location": "Конференц-зал",
    "description": "Описание встречи",
    "attendees": [
      {"name": "Иван Иванов", "email": "ivan@example.com"}
    ],
    "google_event_id": "abc123def456",
    "created_at": "2025-01-13T09:00:00",
    "updated_at": "2025-01-13T14:30:22"
  },
  "backup_id": "delete_123_20250113_143022"
}
```

## Безопасность

### Защита от случайного удаления

- Все удаления логируются с пометкой "ВАЖНОЕ СОБЫТИЕ" для событий с ключевыми словами
- Backup'ы сохраняются на месяц для возможности восстановления
- Детальное логирование всех операций для аудита

### Восстановление

- Можно восстановить только удаленные события
- Восстановление создает новое событие с новым ID
- Все участники и метаданные восстанавливаются полностью
- Google Calendar ID сохраняется для повторной синхронизации

## Мониторинг

### Логи для мониторинга:

1. **officer.log** - общий лог всех операций
2. **event_backups.log** - детальные backup'ы для восстановления
3. **event_restores.log** - операции восстановления
4. **google_calendar.log** - синхронизация с Google Calendar
5. **errors.log** - все ошибки системы

### Ключевые события для мониторинга:

- `BACKUP DELETE` - удаление события (требует внимания)
- `RESTORE SUCCESS` - успешное восстановление
- `RESTORE FAILED` - ошибка восстановления
- `google_calendar_sync_success` - успешная синхронизация
- `google_calendar_sync_failed` - ошибка синхронизации

## Примеры использования

### Восстановление случайно удаленного события:

1. Найдите backup в логах:
```bash
grep "BACKUP DELETE" logs/event_backups.log | tail -10
```

2. Получите список доступных backup'ов:
```bash
curl http://localhost:5001/api/events/backups
```

3. Восстановите событие:
```bash
curl -X POST http://localhost:5001/api/events/restore/delete_123_20250113_143022
```

### Мониторинг синхронизации:

```bash
# Проверить успешные синхронизации
grep "google_calendar_sync_success" logs/officer.log

# Проверить ошибки синхронизации
grep "google_calendar_sync_failed" logs/officer.log
```

## Технические детали

### Структура backup'а:
- **timestamp** - точное время операции
- **operation** - тип операции (create/update/delete)
- **event_id** - ID события
- **event_data** - полные данные события
- **backup_id** - уникальный ID backup'а

### Ротация логов:
- **event_backups.log**: 50MB, 30 файлов (месяц)
- **event_restores.log**: 10MB, 14 файлов (2 недели)
- **officer.log**: 10MB, 7 файлов (неделя)

### Производительность:
- Backup'ы создаются асинхронно
- Не влияют на производительность основных операций
- Сжатие старых логов для экономии места

