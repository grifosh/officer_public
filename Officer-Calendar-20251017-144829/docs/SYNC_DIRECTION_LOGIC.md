# Логика определения направления синхронизации

## Как система понимает что событие в Google обновилось последним

### 1. Временные метки для сравнения

**Локальная БД:**
- `last_local_update` - когда событие было изменено локально (через UI)
- `last_google_sync` - когда последний раз синхронизировались с Google
- `google_updated_at` - время последнего обновления в Google Calendar

**Google Calendar:**
- `updated` - время последнего изменения события в Google Calendar

### 2. Алгоритм определения направления

```
Есть ли событие в Google Calendar?
├─ НЕТ → local_to_google (создать в Google)
└─ ДА → Есть ли событие локально?
    ├─ НЕТ → google_to_local (создать локально)
    └─ ДА → Сравнить временные метки
        ├─ Нет локального времени → google_to_local
        ├─ Нет Google времени → local_to_google
        └─ Оба времени есть → Сравнить
            ├─ Разница < 1 сек → no_change
            ├─ Разница < 5 сек → conflict (одновременные изменения)
            ├─ local_updated > google_updated → local_to_google
            └─ google_updated > local_updated → google_to_local
```

### 3. Практические примеры

**Пример 1: Google событие новее**
```
Локальное время: 2025-10-13 15:00:00
Google время:    2025-10-13 16:00:00
Результат:       google_to_local (Google новее на 3600с)
```

**Пример 2: Локальное событие новее**
```
Локальное время: 2025-10-13 17:00:00
Google время:    2025-10-13 16:00:00
Результат:       local_to_google (локальное новее на 3600с)
```

**Пример 3: Конфликт (одновременные изменения)**
```
Локальное время: 2025-10-13 16:00:00
Google время:    2025-10-13 16:00:02
Результат:       conflict (разница 2с - одновременные изменения)
```

**Пример 4: Нет локального времени**
```
Локальное время: None (событие создано через Google)
Google время:    2025-10-13 16:00:00
Результат:       google_to_local (Google время известно, локальное нет)
```

### 4. Реальный пример (событие ID 624)

```
Событие: "!!!TEST MEETING!!!"
Локальное время: None (last_local_update = null)
Google время:    2025-10-13T16:24:08.830Z
Последняя синхронизация: 2025-10-13T19:25:21
Результат:       google_to_local (Google событие изменено, локальное время неизвестно)
```

### 5. Ключевые моменты

1. **Приоритет времени**: Система всегда выбирает более новое изменение
2. **Защита от конфликтов**: Если изменения произошли почти одновременно (< 5 сек), система помечает это как конфликт
3. **Неизвестное время**: Если нет информации о времени изменения, система использует доступную информацию
4. **Автоматическая синхронизация**: Система не обновляет `last_local_update` при автоматической синхронизации, только `last_google_sync`

### 6. Поля в базе данных

```sql
-- Поля для отслеживания синхронизации
last_local_update    TIMESTAMP,  -- Когда изменено локально
last_google_sync     TIMESTAMP,  -- Когда последний раз синхронизировались
google_updated_at    TIMESTAMP,  -- Время обновления в Google
sync_source          VARCHAR,    -- 'local' или 'google'
google_event_id      VARCHAR     -- ID события в Google Calendar
```
