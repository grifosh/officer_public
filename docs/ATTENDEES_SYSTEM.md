# Система управления участниками (attendees)

## Описание

Система управления участниками (attendees) предоставляет полный функционал для работы с участниками событий, включая автоматическую синхронизацию, поиск, статистику и корректное удаление.

## Структура базы данных

### Таблица `attendees`

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | INTEGER | Уникальный идентификатор |
| `email` | VARCHAR | Email участника |
| `name` | VARCHAR | Имя участника |
| `surname` | VARCHAR | Фамилия участника |
| `use_count` | INTEGER | Количество использований |
| `last_used` | TIMESTAMP | Последнее использование |
| `last_searched_at` | TIMESTAMP | Последний поиск (может быть NULL) |

## Хранимые процедуры

### 1. `delete_attendee_and_cleanup_events(attendee_email_to_delete TEXT)`

**Назначение**: Корректно удаляет участника из таблицы `attendees` и очищает все события от ссылок на него.

**Параметры**:
- `attendee_email_to_delete` - Email участника для удаления

**Возвращает**: Строку с результатом операции

**Логика работы**:
1. Проверяет существование участника
2. Подсчитывает количество затронутых событий
3. Удаляет email участника из всех событий (поле `attendees`)
4. Удаляет самого участника из таблицы `attendees`
5. Возвращает отчет о выполненной операции

**Пример использования**:
```sql
SELECT delete_attendee_and_cleanup_events('test@example.com');
-- Результат: "Удален участник "Test User" (test@example.com). Затронуто событий: 3"
```

### 2. `cleanup_orphaned_attendees()`

**Назначение**: Очищает все события от несуществующих участников.

**Параметры**: Нет

**Возвращает**: Строку с количеством очищенных событий

**Логика работы**:
1. Находит все события с несуществующими участниками
2. Очищает поле `attendees` от несуществующих email
3. Возвращает количество очищенных событий

**Пример использования**:
```sql
SELECT cleanup_orphaned_attendees();
-- Результат: "Очищено событий с несуществующими участниками: 5"
```

### 3. `update_attendees_last_searched(search_pattern TEXT)`

**Назначение**: Обновляет `last_searched_at` для участников, найденных по поисковому запросу.

**Параметры**:
- `search_pattern` - Поисковый паттерн

**Возвращает**: Количество обновленных участников

**Логика работы**:
1. Ищет участников по email, имени или фамилии
2. Обновляет `last_searched_at` для найденных участников
3. Возвращает количество обновленных записей

**Пример использования**:
```sql
SELECT update_attendees_last_searched('John');
-- Результат: 3 (обновлено 3 участника)
```

## API Endpoints

### 1. `GET /api/attendees`

**Описание**: Получить список участников с поиском

**Параметры**:
- `search` (query, optional) - Поисковый запрос

**Возвращает**: Массив участников с информацией о последнем поиске

**Пример**:
```bash
curl "http://localhost:5001/api/attendees?search=John"
```

### 2. `GET /api/attendees/stats`

**Описание**: Получить статистику по участникам

**Возвращает**: Общую статистику и список участников с информацией о поиске

**Пример**:
```bash
curl "http://localhost:5001/api/attendees/stats"
```

### 3. `POST /api/attendees`

**Описание**: Добавить или обновить участника

**Параметры**:
- `email` (form) - Email участника
- `name` (form, optional) - Имя участника
- `surname` (form, optional) - Фамилия участника

**Возвращает**: Информацию о созданном/обновленном участнике

### 4. `DELETE /api/attendees/by-email/{email}`

**Описание**: Удалить участника и очистить все события от ссылок на него

**Параметры**:
- `email` (path) - Email участника

**Возвращает**: Сообщение о результате операции

**Пример**:
```bash
curl -X DELETE "http://localhost:5001/api/attendees/by-email/test@example.com"
```

### 5. `PUT /api/attendees/cleanup`

**Описание**: Очистить все события от несуществующих участников

**Возвращает**: Сообщение о количестве очищенных событий

**Пример**:
```bash
curl -X PUT "http://localhost:5001/api/attendees/cleanup"
```

### 6. `POST /api/attendees/sync`

**Описание**: Синхронизировать участников из всех событий в таблицу attendees

**Возвращает**: Количество синхронизированных участников

## Автоматическая синхронизация

Система автоматически синхронизирует участников из событий в таблицу `attendees` при:
- Получении списка участников через API
- Создании или обновлении событий
- Запуске автоматической синхронизации с Google Calendar

## Тестирование

### Запуск тестов

```bash
# Тесты базы данных
python tests/test_attendees_simple.py

# Тесты API (требует запущенный сервер)
python tests/test_attendees_api.py
```

### Очистка тестовых данных

После запуска тестов рекомендуется очистить тестовые данные:

```bash
python scripts/cleanup_test_data.py
```

## Интеграция с событиями

### Связь с таблицей `events`

Участники хранятся в поле `attendees` таблицы `events` как массив email адресов:

```sql
-- Пример события с участниками
SELECT id, subject, attendees 
FROM events 
WHERE id = 123;
-- Результат: {123, "Meeting", ["john@example.com", "jane@example.com"]}
```

### Автоматическое обновление

При изменении участников в событии:
1. Участники автоматически добавляются в таблицу `attendees`
2. Обновляется счетчик `use_count`
3. Обновляется `last_used`

## Безопасность

- Все SQL запросы используют параметризованные запросы
- Email адреса валидируются перед добавлением
- Функции безопасны для использования в транзакциях

## Производительность

- Индексы на часто используемые поля (`email`, `last_used`)
- Ограничение результатов поиска (20-50 записей)
- Кэширование часто используемых участников

## Файлы системы

- `scripts/create_attendees_functions.sql` - SQL функции
- `tests/test_attendees_simple.py` - Тесты базы данных
- `tests/test_attendees_api.py` - Тесты API
- `docs/ATTENDEES_SYSTEM.md` - Документация (этот файл)

