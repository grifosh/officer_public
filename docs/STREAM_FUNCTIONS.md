# Хранимые процедуры для управления тегами (streams)

## Описание

В базе данных созданы две хранимые процедуры для корректного управления тегами:

### 1. `delete_stream_and_cleanup_events(stream_id_to_delete INTEGER)`

**Назначение**: Корректно удаляет тег из таблицы `streams` и очищает все события от ссылок на этот тег.

**Параметры**:
- `stream_id_to_delete` - ID тега для удаления

**Возвращает**: Строку с результатом операции

**Логика работы**:
1. Проверяет существование тега
2. Подсчитывает количество затронутых событий
3. Удаляет ID тега из всех событий (поле `stream_ids`)
4. Удаляет сам тег из таблицы `streams`
5. Возвращает отчет о выполненной операции

**Пример использования**:
```sql
SELECT delete_stream_and_cleanup_events(69);
-- Результат: "Удален тег "Тестовый тег для удаления" (ID: 69). Затронуто событий: 1"
```

### 2. `cleanup_orphaned_stream_ids()`

**Назначение**: Очищает все события от несуществующих ID тегов.

**Параметры**: Нет

**Возвращает**: Строку с количеством очищенных событий

**Логика работы**:
1. Находит все события с несуществующими ID тегов
2. Очищает поле `stream_ids` от несуществующих ID
3. Возвращает количество очищенных событий

**Пример использования**:
```sql
SELECT cleanup_orphaned_stream_ids();
-- Результат: "Очищено событий с несуществующими ID тегов: 1"
```

## Обработка ошибок

- При попытке удалить несуществующий тег функция возвращает сообщение об ошибке
- Функции безопасны для использования в транзакциях
- Все операции выполняются атомарно

## Интеграция с API

Эти функции можно вызывать через API endpoints для:
- Удаления тегов с автоматической очисткой событий
- Периодической очистки базы данных от несуществующих ссылок
- Миграции данных при изменении структуры

## Файл создания

Функции определены в файле: `scripts/create_stream_functions.sql`


